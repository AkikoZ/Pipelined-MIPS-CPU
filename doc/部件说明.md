# 部件说明

## 流水线控制部件

### `pipeline_control`

#### 功能说明

该部件负责通过向各流水线寄存器发送暂停或冒泡等控制输入来应对流水线中可能出现的冒险。

#### 设计思路

流水线控制部件根据当前执行阶段的相应输出作为输入，如果当前输入的 `E_op` 为 `ILW`，且 `E_dstM` 不为空寄存器，说明 CPU 需要在访存阶段才能从内存中读取数据，那么在这里存在数据冒险的可能，需要向取指阶段、译码阶段的流水线寄存器发送暂停信号，向执行阶段的流水线寄存器发送气泡信号，所以流水线控制部件将相应的信号量 `F_stall` / `D_stall` / `E_bubble` 被设置成 **1**，
相反则将相应信号量设置成 **0**，说明流水线中不存在数据冒险。

## 取指阶段部件

### `F_reg`

#### 功能说明

该部件为取指阶段流水线寄存器，在该 CPU 中可以简单地看作一个可接收流水线控制信号的 PC。

#### 设计思路

在时钟上升沿时，取指阶段流水线根据数据输入 `f_val` / `F_stall` 来更新相应的输出 `F_valP`。
如果 `F_stall` 为 0，则说明当前取指阶段流水线寄存器处于正常工作阶段，寄存器用 `next_pc` 部件计算出的下一个 PC 值更新当前 PC 值；
如果 `F_stall` 为 1，说明当前取指阶段流水线需要暂停一个时钟周期，则不进行相应的更新 PC 的操作。

### `instr_mem`

#### 功能说明

该部件为指令存储器，负责存储与读取指令，也集成了分解指令与扩展立即数的功能。

#### 设计思路

指令存储器部件内部根据当前的 PC 值，从存储指令的存储器中读取当前需要执行的指令，然后指令存储器将指令分解成 `op`、`rs`、`rt`、`rd` 或 `valC` 等寄存器或立即数
如果当前指令存在相应立即数，指令存储器会根据立即数的类型对立即数进行符号扩展或无符号扩展。

存储指令的存储器用 `reg` 类型变量的数组模拟实现，指令存储器在初始化时，会通过 `$readmemh(IM_DATA, insts, 0, 15)`， 从 `/data/instr_memory.txt` 中读取预先设计好的相应指令。

### `next_pc`

#### 功能说明

该部件负责根据当前指令信息计算下一个 PC 值。

#### 设计思路

部件根据当前的 `F_op` 计算下一个 PC 值，如果 `F_op` 为 `IJ`， 说明当前指令是跳转指令，则下一个 PC 值会根据当前的立即数和当前 PC 的前四位，计算出新的 PC 值；反之，则当前 PC 值进行简单的自增 4 操作。

## 译码阶段部件

### `D_reg`

#### 功能说明

该部件为译码阶段流水线寄存器。

#### 设计思路

在时钟上升沿到来时，译码阶段流水线根据数据输入 `D_stall` 来决定是否需要更新寄存器的相应输出。如果相应的值为 **1**，说明译码阶段流水线寄存器处于暂停阶段，那么暂停更新寄存器的相应输出；如果对应的值为 **0**，那么说明流水线寄存器处于正常工作阶段，流水线寄存器根据取指阶段分解的指令 `f_op` / `f_func` / `f_rs` / `f_rt` / `f_rd` / `f_valC` 更新译码阶段的相应值 `D_op` / `D_func` / `D_rs` / `D_rt` / `D_rd` / `D_valC`。

### `dstE`

#### 功能说明

该部件负责根据当前指令决定该指令中 ALU 输出应该写回的寄存器。

#### 设计思路

部件根据输入 `D_op`，决定 ALU 输出应该写回的寄存器。

如果寄存器输入 `D_op` 的值为 `IROP`，则 ALU 输出寄存器是 `rd`；如果值为 `IADDI`、`IORI` 等寄存器中的值与立即数进行运算的操作，则 ALU 输出寄存器是 `rt`；如果值为 `IJ`，则输出寄存器为 `RNONE`，即不需要输出寄存器。

### `dstM`

#### 功能说明

该部件负责根据当前指令决定该指令中存储器输出应该写回的寄存器。

#### 设计思路

部件根据输入 `D_op`，决定存储器输出应该写回的寄存器。

如果寄存器输入的值为 `ILW`，说明当前指令需要从存储器中加载相应值到寄存器，所以输出寄存器对应为 `rt`；反之
说明不需要从存储器中加载相应值，则不需要输出寄存器，相应值被设置成 `RNONE`。

### `srcA`

#### 功能说明

该部件负责根据当前指令决定该指令中第一个要读的寄存器。

#### 设计思路

`srcA` 部件对应相应的寄存器 `rt`，如果当前指令需要从 `rt` 寄存器中读取相应值时，相应值输出到 `D_srcA`，如果不需要则相应 `D_srcA`置空。

### `srcB`

#### 功能说明

该部件负责根据当前指令决定该指令中第二个要读的寄存器。

#### 设计思路

`srcB` 部件对应相应的寄存器 `rs`，如果当前指令需要从 `rs` 寄存器中读取相应值时，相应值输出到 `D_srcB`，如果不需要则将相应 `D_srcB` 置空。

### `reg_file`

#### 功能说明

该部件为该 CPU 的寄存器文件，负责寄存器数据的读取与写入。

#### 设计思路

寄存器部件内部用 `reg [31:0] regs [0:15]` 模拟了 CPU 中的寄存器，在初始时所有寄存器的值会被初始化成 0。

寄存器部件根据需要读取寄存器 `d_srcA` 和 `d_srcB`，如果相应寄存器不为 `RNONE`，说明需要从该寄存器中读取相应值，那么部件输出相应寄存器的值 `d_rvalA` 和 `d_rvalB`。

当每个时钟下降沿到来时，部件根据输入 `W_dstM` / `W_dstE` / `W_valM` / `W_valE` 来决定是否将相应值写入目的寄存器，如果相应寄存器 `W_dstX` 不为空，则将相应值 `W_valX` 赋值给该寄存器。

### `fwdA`

#### 功能说明

该部件负责根据当前流水线状态决定需要转发为第一个寄存器读的值。

#### 设计思路

转发部件根据输入 `E_dstE` / `M_dstE` / `M_dstM` / `W_dstE` / `W_dstM` 和 `d_srcA` 的比较决定转发的值，如果二者的值相等，则转发 `e_valE` /  `M_valE` / `m_valM` / `W_valE` / `W_valM`，如果均不符合，则直接转发 `d_rvalA`。

### `fwdB`

#### 功能说明

该部件负责根据当前流水线状态决定需要转发为第二个寄存器读的值。

#### 设计思路

转发部件根据输入 `E_dstE` / `M_dstE` / `M_dstM` / `W_dstE` / `W_dstM` 和 `d_srcB` 的比较决定转发的值，如果二者的值相等，则转发 `e_valE` /  `M_valE` / `m_valM` / `W_valE` / `W_valM`，如果均不符合，则直接转发 `d_rvalB`。

## 执行阶段部件

### `E_reg`

#### 功能说明

该部件为执行阶段流水线寄存器。

#### 设计思路

在时钟上升沿到来时，执行阶段流水线根据数据输入 `E_bubble` 来决定是否如何更新寄存器的相应输出。如果相应的值为 **1**，说明执行阶段流水线需要插入气泡，那么将相应寄存器的相应输出全部置成空，那么这个时钟周期内，执行阶段不进行任何操作；如果对应的值为 **0**，那么说明流水线寄存器处于正常工作阶段，流水线寄存器根据译码阶段的相应输入 `D_op` / `D_func` / `D_valA` / `D_valB` / `D_valC` / `D_dstE` / `D_dstM` / `D_srcA` / `D_srcB` 更新执行阶段的相应输出 `E_op` / `E_func` / `E_valA` / `E_valB` / `E_valC` / `E_dstE` / `E_dstM` / `E_srcA` / `E_srcB`。

### `aluA`

#### 功能说明

该部件负责根据当前指令决定 ALU 的第一个操作数。

#### 设计思路

当前部件相应的输出有两种可能：来自 `rt` 寄存器的值 `E_valA`，或者是立即数 `E_valC`，所以部件会根据输入 `E_op` 的值判断应该输出那一个。如果值为 `IROP`，则指令对应着相应种类的寄存器操作，所以输出 `E_valA`，反之则输出立即数 `E_valC`。

### `aluB`

#### 功能说明

该部件负责根据当前指令决定 ALU 的第二个操作数。

#### 设计思路

因为该部件对应的输入恒来自寄存器 `rs` 的值，所以当前需要进行数学运算时，会用来自 `rs` 寄存器的值 `E_valB` 更新对应输出 `e_aluB`。

### `alufunc`

#### 功能说明

该部件负责根据当前指令决定 ALU 的操作符。

#### 设计思路

由于目的设计的 CPU 在 alufunc 上无需任何判断条件，所以可以直接通过连线的方式，将输入 `E_alufunc` 和输出 `e_alufunc` 相连。

### `alu`

#### 功能说明

该部件为该 CPU 的 ALU，负责执行算术运算。

#### 设计思路

alu模块根据输入的 `e_alufunc` 判断运算的类型，然后根据输入的 `e_aluA` 和 `e_aluB` 计算出运算后的结果值，然后将结果值输出到 `e_valE`。

## 访存阶段部件

### `M_reg`

#### 功能说明

该部件为访存阶段流水线寄存器。

#### 设计思路

根据访问阶段需要进行的操作，在每个时钟上升沿到来时，访存阶段流水线寄存器会根据执行阶段的 `E_op` / `E_dstE` / `E_dstM` / `e_valE` / `E_valM` 更新访存阶段的对应值 `M_op` / `M_dstE` / `M_dstM` / `M_valE` / `M_valM`。

### `data_mem`

#### 功能说明

该部件为数据存储器，负责存储与读写数据。

#### 设计思路

数据存储器部件内部用 `reg [31:0] data [0:63]` 模拟了大小为 256 字节的内存结构，初始化时相应数据被全部置成 0。

当访存阶段的 `M_op` 为 `ILW`，说明 CPU 需要从内存中访问数据时，数据存储器根据输入 `M_valE` 从内存中取出相应的数据，并输出到 `m_valM`。

当访存阶段的 `M_op` 为 `ISW`，并且 CPU 需要将相应数据存入内存时，数据存储器根据输入 `M_valE`，将需要存入的值 `M_valA` 存入内存中的相应位置。

## 写回阶段部件

### `W_reg`

#### 功能说明

该部件为写回阶段流水线寄存器。

#### 设计思路

写回阶段的流水线寄存器的功能较为简单，只需要在每个时钟上升沿到来之时，根据来自访存阶段的目标寄存器（`M_dstE` 和 `M_dstM`）、需要写入的相应值（`M_valE` 和 `M_valM`）更新写回阶段的目标寄存器（`W_dstE` 和 `W_dstM`）、需要写入的值（`W_valE` 和 `W_valM`）。
